---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostCard from '../../../components/PostCard.astro';

export async function getStaticPaths() {
  // Tag mapping: tag value -> URL slug
  const tagMapping: Record<string, string> = {
    'life': 'life',
    'making': 'making',
    'obj': 'obj',
  };

  // Reverse mapping: URL slug -> display name (English)
  const slugToDisplay: Record<string, string> = {
    'life': 'Life',
    'making': 'Making',
    'obj': 'Objects',
  };

  // Get the URL slug for a tag
  const getTagSlug = (tag: string): string => {
    return tagMapping[tag] || tag;
  };

  // Get all tags that map to a given slug
  const getTagsForSlug = (slug: string): string[] => {
    const tags = [slug];
    for (const [displayTag, mappedSlug] of Object.entries(tagMapping)) {
      if (mappedSlug === slug) {
        tags.push(displayTag);
      }
    }
    return tags;
  };

  const posts = await getCollection('blog-en', ({ data }) => !data.draft);

  // Get all unique tags from posts
  const allTags = [...new Set(posts.flatMap((post) => post.data.tags))];

  // Get unique slugs (normalized tags)
  const uniqueSlugs = [...new Set(allTags.map(getTagSlug))];

  // Build paths for each unique slug
  return uniqueSlugs.map((slug) => {
    const relatedTags = getTagsForSlug(slug);
    const displayTitle = slugToDisplay[slug] || slug;

    return {
      params: { tag: slug },
      props: {
        tag: slug,
        displayTitle,
        posts: posts
          .filter((post) => post.data.tags.some((t) => relatedTags.includes(t)))
          .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
      },
    };
  });
}

interface Props {
  tag: string;
  displayTitle: string;
  posts: Awaited<ReturnType<typeof getCollection<'blog-en'>>>;
}

const { tag, displayTitle, posts } = Astro.props;
---

<BaseLayout
  title={`${displayTitle} - Saltwind`}
  description={`All posts about ${displayTitle}`}
  lang="en"
  alternateUrl={`/tags/${tag}/`}
>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <header class="mb-12">
      <a
        href="/en/"
        class="inline-flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors mb-4"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Home
      </a>
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4">
        {displayTitle}
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        {posts.length} {posts.length === 1 ? 'post' : 'posts'}
      </p>
    </header>

    {posts.length > 0 ? (
      <ul class="space-y-8">
        {posts.map((post) => (
          <li class="pb-8 border-b border-gray-200 dark:border-gray-800 last:border-b-0 last:pb-0">
            <PostCard post={post} basePath="/en/blog" />
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-gray-600 dark:text-gray-400">
        No posts yet.
      </p>
    )}
  </div>
</BaseLayout>
